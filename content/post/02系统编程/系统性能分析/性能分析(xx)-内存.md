
# 性能分析(3)——内存 #

top命令可以查看系统内存信息，如需详细信息可使用以下命令。其中vmstat可以很好的展示内存和IO信息。

## 1. free——系统内存使用情况 ##

free命令可以显示当前系统未使用的和已使用的内存数目，还可以显示被内核使用的内存缓冲区。

```
$ free
             total       used       free     shared    buffers     cached
Mem:       2079008     520952    1558056        152      68232     396756
-/+ buffers/cache:      55964    2023044
Swap:       524284          0     524284
```

* shared：当前已经废弃指标。
* buffers：用于块设备I/O的缓冲区高速缓存的大小。
* cached：文件系统使用的页缓存大小。
* -/+ buffers/cache：used=第一部分 used – buffers – cached，代表实际被程序占用的内存；free=第一部分 free + buffers + cached，代表还能被挪用的内存。
* swap：交换分区信息。

注意，缓冲区buffer是用来缓冲块设备的，它只记录文件系统的元数据以及跟踪瞬时页面，而缓存cached用来给文件作缓冲。换句话说，缓冲区主要用来存放目录内容，文件属性及权限等，而缓存直接用来记忆打开用户使用过的文件和程序，

## 2. vmstat——统计虚拟内存信息 ##

```
$ vmstat 1
procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0      0 1560036  67508 395308    0    0     0     0   13   11  0  0 100  0  0
 0  0      0 1560036  67508 395308    0    0     0     0   50   37  0  0 100  0  0
 0  0      0 1560068  67508 395308    0    0     0     0   35   47  0  0 100  0  0
 0  0      0 1560068  67508 395308    0    0     0     0   34   43  0  0 100  0  0
 0  0      0 1560068  67508 395308    0    0     0     0   33   38  0  0 100  0  0
```

***Procs（进程）***

* r：CPU负载（当前正在被CPU执行和等待CPU执行的进程数目总和）。
* b: 等待IO的进程数量。

***Memory（内存）***

* swpd: 使用交换区大小，如果swpd的值不为0，但是SI，SO的值长期为0，这种情况不会影响系统性能。（SWAP就是LINUX下的虚拟内存分区，它的作用是在物理内存使用完之后,将磁盘空间(也就是SWAP分区)虚拟成内存来使用）
* free: 空闲物理内存大小，单位KB。
* buff: 用于块设备I/O的缓冲区高速缓存的大小。
* cache: 文件系统使用的页缓存大小。如果cache的值大的时候，说明cache处的文件数多，如果频繁访问到的文件都能被cache处，那么磁盘的读IO bi会非常小。

***Swap***

* si: 每秒从交换区写到内存的大小，由磁盘调入内存。
* so: 每秒写入交换区的内存大小，由内存调入磁盘。

注意：内存够用的时候，这2个值都是0，如果这2个值长期大于0时，系统性能会受到影响，磁盘IO和CPU资源都会被消耗。空闲内存（free）很少的或接近于0时，并不代表内存不够用了，此时需要结合si和so，如果free很少，但是si和so也很少（大多时候是0），那么不用担心，系统性能这时不会受到影响的。

***IO***

* bi: 每秒读取的块数
* bo: 每秒写入的块数

注意：随机磁盘读写的时候，这2个值越大（如超出1024k)，能看到CPU在IO等待的值也会越大。

***system（系统）***

* in: 每秒中断数，包括时钟中断。
* cs: 每秒上下文切换数。

注意：上面2个值越大，会看到由内核消耗的CPU时间会越大。

***CPU（以百分比表示）***

us, sy, id, wa, st：CPU时间的不同组成部分，是所有CPU的平均数。分别表示用户态时间、系统态时间（内核）、空闲、等待I/O以及窃取时间（stolen time，虚拟化环境下，CPU在其他租户上的开销）。

* us: 用户进程执行时间百分比(user time)。us的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超50%的使用，那么我们就该考虑优化程序算法或者进行加速。
* sy: 内核系统进程执行时间百分比(system time)。sy的值高时，说明系统内核消耗的CPU资源多，这并不是良性表现，我们应该检查原因。
* wa: IO等待时间百分比。wa的值高时，说明IO等待比较严重，这可能由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈（块操作）。
* id: 空闲时间百分比

将用户态时间和系统态时间相加，可以判断CPU是否忙碌。如果一直有等待I/O，表明存在磁盘瓶颈。因为任务阻塞等待磁盘I/O，此时CPU是空闲的。可以将等待I/O看作另一种形式的CPU空闲。


## 相关链接 ##

《性能之巅》，Brandan Gregg，第7章，内存