# 架构之路(01)——架构设计核心要素 #

一般来说，除了当前的系统功能需求外，软件架构设计还需要关注性能、可用性、伸缩性、扩展性和安全性这5个架构要素。

## 1. 性能 ##

衡量系统性能的主要指标如下。详细说明参考《性能分析(1)——系统性能指标》。

* 响应时间
* 吞吐量
* 最大并发数
* 系统负载

常见优化手段如下。

* 浏览器端：减少HTTP请求（合并文件，如CSS、JS、图片等），使用浏览器缓存、启用页面压缩、合理布局页面（CSS放在页面最上，浏览器会在下载完全部CSS后才对页面进行渲染；JS放在页面最下，浏览器加载JS后立即执行，可能阻塞页面导致展示缓慢）、减少cookie传输
* CDN和反向代理：缓存热点文件，加快响应速度，减轻应用服务器负载压力
* 应用服务器端：本地缓存、分布式缓存
* 异步操作与消息队列：具有很好的削峰作用，任何可以晚点做的事情都应该晚点再做。
* 使用集群提高并发处理能力：负载均衡策略
* 代码层面：多线程、改善内存管理
* 数据库端：索引、sql优化，nosql
* 存储

## 2. 高可用 ##

*  RTO（Recovery Time Objective）：即恢复时间目标，主要指当发生灾难或紧急事件时，业务系统所能容忍的停止服务的最长时间，也就是从灾难发生到业务系统恢复服务功能所需要的最短时间周期。
*  RPO（Recovery Point Objective）：即数据恢复点目标，主要指当发生灾难或紧急事件时，业务系统所能容忍的数据丢失量。例如每天凌晨1:00进行数据备份，那么如果今天发生了宕机事件，数据可以恢复到的最糟糕的增备时间点（RPO）就是昨天的凌晨1:00。

可用性度量：(一般知名大型网站保证4个9，即99.99%)

```
故障时间=故障修复点-故障发生点
可用性指标=(1-故障时间/年度总时间)*100%
```

| 可用性指标              | 故障时间                                    |
|-------------------|---------------------------------------------|
| 99%           | <88hour  |
| 99.9% | <9hour  |
| 99.99%              | <53min  |
| 99.999%            | <5min |

实现高可用架构的主要手段是数据和服务的冗余备份及失效转移。

* 构建无状态服务。
* 通过负载均衡进行无状态服务的失效转移。

当然，事实上，业务总是有状态的，例如应用服务器session，可以采用集群复制、绑定、cookie、专用服务器等方式来解决，也可以采用JWT等方式来实现无会话。

对服务器程序来说，究竟是有状态服务，还是无状态服务，其判断依旧是指两个来自相同发起者的请求在服务器端是否具备上下文关系。如果是状态化请求，那么服务器端一般都要保存请求的相关信息，每个请求可以默认地使用以前的请求信息。而对于无状态请求，服务器端所能够处理的过程必须全部来自于请求所携带的信息，以及其他服务器端自身所保存的、并且可以被所有请求所使用的公共信息。

要构建高可用的服务，通常可以考虑如下的手段：

* 灰度发布
* 监控预警
* 服务分级
* 服务降级：采用拒绝服务等手段。
* 超时设置
* 异步调用
* 幂等设计：对于转账交易等复杂操作，需要通过交易编号等信息进行服务调用有效性校验，只有有效操作才能继续执行。

## 3. 伸缩性 ##

伸缩性是指通过不断向集群中加入服务器的手段来缓解不断上升的用户并发访问压力和不断增长的数据存储需求。伸缩性要求中不改变系统软硬件设计下，仅仅通过改变部署的服务器数量就可以扩大或缩小系统的服务处理能力。

一般来说伸缩性设计思想如下：

* 垂直拆分：根据功能（按业务流程或业务模块划分）进行物理分离
* 水平拆分：节点分组，每个分组处理业务数据的一个子集
* 单一功能通过集群实现伸缩

## 4. 扩展性 ##

指对现有系统影响最小的情况下，系统功能可持续扩展或提升点能力。

衡量扩展性好坏的主要标准就是在网站增加新的业务产品时，是否可以实现对现有产品透明无影响。

表现在系统基础设施稳定不需要经常变更，应用之间较少依赖和耦合，当系统增加新功能时，不需要对现有系统的结构和代码进行修改。

可扩展架构的主要手段是事件驱动架构和分布式服务。

* 事件驱动架构：Event Driven Architecture，通过在低耦合的模块之间传输事件消息，以保持模块的松散耦合，并借助事件消息的通信完成模块间合作，典型的EDA架构就是OS中常见的生产者消费者模式。

事件驱动通常利用消息队列实现，通过这种方式将消息生产和处理逻辑分隔开。

服务器服务则是将业务和可复用服务分离开来，通过分布式服务框架调用。新增加产品可用通过调用可复用的服务来实现自身的业务逻辑，而对现有产品没有任何影响。

低耦合。

在软件范畴上，是软件系统本身的属性，或者进一步说是设计的属性，代码的属性。因为我们经常说设计的可扩展性，代码的可扩展性.也可以说是系统设计的松耦合性。

软件的可扩展性设计非常重要，但又比较难以掌握，业界试图通过云计算或高并发语言等方式节省开发者精力，但是，无论采取什么技术，如果应用系统内部是铁板一块，例如严重依赖数据库，系统达到一定访问规模，负载都集中到一两台数据库服务器上，这时进行分区扩展伸缩就比较困难

国际化、语言、多时区等。

## 5. 安全性 ##