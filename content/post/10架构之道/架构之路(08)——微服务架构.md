# 架构之路(08)——微服务架构 #

## 1. 巨石型应用-传统单体垂直架构 ##

传统的单体架构系统一般采用MVC横向分层模型，即常说的三层架构。

* View：视图展示层，用于前端交互界面展示，并能接收用户输入。
* Controller：调度控制层，用于接收前端的请求，并调用对应的模型层业务逻辑执行请求，最后调用相应的视图来展示模型层返回的数据。
* Model：模型层是应用程序的主体部分，代表了业务数据和业务执行逻辑。

随着单体架构系统越来越庞大和复杂，可能带来如下问题。

* 代码重复率高：团队规模大，不同开发小组无法实现无缝沟通和共享，大量本地API实现的公共组件被重复开发，无法有效做到代码复用。
* 部署效率低：模块过多，编译、部署时间长。编译中途出错需要全部重新编译。
* 应用复杂性高，需求变更困难：长流程无法有效拆分（新功能无法独立部署和交付），代码重复率高（公共API修改导致测试工作量激增），导致每次需求变更影响面大，需要做大量回归测试，交付周期被拉长。
* 系统可靠性变差：同一进程部署到多个对等节点，应用某个节点发生故障，常常意味着其他节点也有类似问题，可能引起雪崩效应。
* 资源利用率低：大量的专有机器导致资源浪费。

## 2. SOA ##

当软件系统架构复杂性增长到一定程度时，单纯的横向分层已经不管用了，此时需要对系统按照业务场景进行垂直拆分。随着垂直拆分，拆分出的应用成为信息孤岛，应用之间需要进行信息互通，SOA应运而生，SOA通常使用RPC来进行服务间的接口通信。此时系统架构演进需要保持标准化，可复用，互操作，松耦合。

* SOA（Service-Oriented Architecture，面向服务架构）：SOA是一个组件模型，它将应用程序的不同功能单元（称为服务）通过这些服务之间定义良好的接口和契约联系起来。接口是采用中立的方式进行定义的，它应该独立于实现服务的硬件平台、操作系统和编程语言。这使得构建在各种各样的系统中的服务可以使用一种统一和通用的方式进行交互。

随着SOA系统的发展，系统开始面临一些新的问题。

* 没有定义服务组件的粒度。
* 服务间的调用由应用自己管理，十分混乱。（随着服务增长，服务URL配置管理越来越困难，F5等硬件负载均衡器的单点压力也越来越大。业务间调用关系错综复杂，混乱不清。缺少服务的容量、权限、跟踪等等管理。）

ESB（enterprise service bus，企业服务总线）概念试图被用于解决SOA的依赖管理问题。但实际上，这种做法仅是将服务管理逻辑转移至ESB，实际问题仍未得到有效解决，此时ESB将变成系统的老大难模块。

## 3. 微服务 ##

    http://12factor.net

**什么是微服务：微服务可以看作是SOA的定制化实现**

微服务的认识常常存在以下误区：

* 微服务=API
* 微服务=Web Service
* 微服务=SOA

微服务是一种架构风格，一个大型复杂软件应用由一个或多个微服务组成。系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。每个微服务仅关注于完成一件任务并很好地完成该任务。在所有情况下，每个任务代表着一个小的业务功能。

尽管“微服务”这种架构格没有精确的定义，但其具有某些共同的特性和原则：

* 一组小的服务：微服务架构中的微服务被定义为可被独立替换和升级的软件单元。微服务很小，每个微服务专注做好一件事，秉承单一职责的原则。
* 基于业务能力：微服务是基于业务能力构建的。微服务通常很小，但是，粒度越小代表服务越多，就越难管理。对此需要进行权衡，一般的指导意见是“围绕业务能力去组织服务，服务划分应与组织架构相匹配”，即依据业务边界确定服务边界。
* 独立的进程：微服务一般是运行在独立的进程中的。典型的场景是部署在容器中。
* 独立部署：微服务是独立部署的实体。
* 轻量级通信：采用轻量级的通信协议，通过API支持异构系统，比如HTTP。
* 无集中式管理：不同的技术栈，不同的存储机制。去中心化的服务治理，以及去中心化的数据管理。

不同于传统IT，微服务下的开发面向产品（长期的）而非项目（临时的）。

独立部署的好处？数据源独立的挑战？

引进微服务架构需要思考的问题：

* 应用分解：依据业务边界确定服务边界。优先单体应用架构思路，逐渐拆解。
* 资源规划和容器编排
* 服务通讯和管理
* 安全互联
* 服务发现和负载均衡
* 分段升级
* A/B测试
* 智能限速
* 认证
* 权限控制
* 监控和日志：微服务架构所带来的一个后果是必须考虑每个服务的失败容错机制。 因此,微服务通常重视建立架构及业务相关指标的实时监控和日志机制。

微服务的基础框架。

* 基础服务框架：docker、容器编排工具、配置管理中心、限流和容错（熔断器）、安全框架、文档自动生成等。
* 服务注册和发现：解决服务管理问题，如Eureka、zookeeper等。
* 负载均衡：解决并发压力。提供故障转移，实现高可用。提供弹性伸缩。安全防护（黑白名单）等。
* 健康检查：监控框架、日志框架。

## 4. 微服务与中台战略 ##

大中台，小前台的策略。轻量的前台应用能够更灵活的适应业务的变化，赋能业务持续创新，快速支持不同业务模式。

业务前台：应用（主站、APP）、渠道（第三方接入）
业务中台：核心业务层提供核心业务服务（基础服务->聚合服务）
技术中台：IaaS（计算、存储、网络、监控、安全、IDC）-> 大数据、AI、PaaS（应用监控、持续交付、服务框架、资源调度、后台服务）

## 5. 分布式服务开发框架 ##

通常，分布式服务框架的架构可以抽象成三层，从下至上分别为：

* RPC层：包括底层通信框架、序列化/反序列化框架等。
* Filter Chain层：服务调用职责链，提供多种服务调用切面供框架自身和使用者扩展，例如负载均衡、服务调用性能统计、服务调用完成通知机制、失败重发等。
* Service层：服务调用方的本地代理、服务提供方的反射实现。

从功能层面上看，分布式服务开发框架通常包含两个主要功能：

* 服务注册中心负责服务注册和发现。
* 服务治理中心包含服务治理接口和portal等。

https://12factor.net/zh_cn/

> 12factor.net
> 《分布式服务框架 原理与实践》 李林锋
