# 架构之路(04)——负载均衡策略 #

性能架构设计和高可用架构设计中都会涉及到负载均衡这项技术。

* 负载均衡：LoadBalancer， 即LB，将流量和数据分摊到服务器集群上，提高系统整体的负载处理能力，同时提供失效转移的功能。

## 1. 常见负载均衡算法 ##

* 随机
* 轮询调度：创建一个服务器序列然后按序分配连接，这是一个简单高效的算法，请求复杂度相同时可以工作得很好。
* 加权轮询调度：所有工作服务器都会被预分配一个权值，调度器仍使用轮询方式，但是在轮询过程中向权值较高的服务器分配更多的负载。需要人工干预。
* 最小连接调度：将连接分发给活动连接数最小的工作服务器。因为需要计算活动连接数，所以开销较大。
* 加权最小连接调度：连接数最小、权重比最高的服务器处理下一条请求，算法是连接数除以权值。需要人工干预，且开销较大。
* 基于局部性的最小连接调度：只要服务器没有过载并处于可用状态，便可将针对同一个终端用户的连接任务分配给同一台工作服务器。否则，将它分配给连接数最少的服务器。这样可以支持相同源IP连接到同一台工作服务器上。由于NAT技术存在，单个IP地址后可能有大量用户，很容易出现过载。
* 源地址散列：根据请求来源IP地址进行HASH计算，得到真实应用服务器，这样来自同一个IP地址的请求总是在同一个服务器上处理。

## 2. 负载均衡分类 ##

按集中负载均衡和客户端负载均衡分：（三种服务发现机制）

* 集中式LB：服务调用方和服务提供方之间有一个独立的LB节点。这种方式的问题是存在单点，LB容易成为瓶颈，并且调用方和服务提供方之间增加了一跳（hop），有一定性能开销。
* 客户端LB（进程内）：服务调用方和提供方之外，单独设立注册中心（ZK、ETCD、Consul等），服务提供方将服务地址列表注册到注册中心，LB相关功能以库的形式集成到调用方进程中，调用方要访问某个服务时通过内置LB向注册中心获取目标服务列表并根据负载均衡策略选择一个目标地址进行访问。这种方式到问题是，异构系统可能需要开发维护多个客户端库，并且LB升级推广阻力大。
* 客户端LB（独立进程）：与客户端LB（进程内）方式类似，但是LB和服务发现功能从进程中移出，变成主机上一个独立进程。这样可以实现与调用方解耦，但是部署复杂，出差调试排查问题不方便。

> 注意，关于集中式LB，即使使用LVS+VIP技术，节点故障切换也是在秒级别的，可能存在10s左右无法提供服务。

按硬件和软件实现分：

在众多的负载均衡集群解决方案中，有基于硬件的负载均衡设备，如F5、Big-IP等，也有基于软件等负载均衡产品，如HAProxy、LVS、Nginx等。在基于软件等负载均衡产品中，又分为两种实现方式：基于OS的软负载实现和基于第三方应用的负载实现，LVS属于前者，HAProxy和Nginx属于后者。

根据OSI模型可将负载均衡分为：

* 二层负载均衡（一般是用虚拟mac地址方式，外部对虚拟MAC地址请求，负载均衡接收后分配后端实际的MAC地址响应）
* 三层负载均衡（一般采用虚拟IP地址方式，外部对虚拟的ip地址请求，负载均衡接收后分配后端实际的IP地址响应）
* 四层负载均衡（在三层负载均衡的基础上，用 ip+port 接收请求，再转发到对应的机器）
* 七层负载均衡（根据虚拟的url或是IP，主机名接收请求，再转向相应的处理服务器）。

## 3. 集中式LB：HTTP重定向负载均衡 ##

HTTP重定向服务器是一台普通的应用服务器，其唯一的功能就是根据用户的HTTP请求计算一台真实的WEB服务器地址，并将该WEB服务器地址写入HTTP重定向响应中（响应状态码302）返回给调用方。

实践中使用HTTP重定向负载均衡的情况并不多见，因为调用方需要两次请求访问，性能较差，并且重定向服务器自身处理能力将会成为瓶颈。

## 4. 集中式LB：基于DNS的负载均衡 ##

DNS将域名映射为IP地址，可以通过设置多个A记录的方式，提供简单的负载均衡功能。DNS负载均衡具有如下特点：

* 容错性较差：某台服务器宕机的情况下，DNS无法判别，仍会将域名解析到有问题的服务器上。目前，某些智能DNS服务支持配置健康检查端口，可以解决这个问题。
* 负载方式：可能达不到一个比较平衡的状态。比如解析结果可能跟访问者的运营商或所处地区有关。
* 无状态记录：不能保证每次连接都到上一次连接到浏览器上。
* TTLCache

## 5. 集中式LB：反向代理负载均衡 ##

大多数反向代理服务器同时提供负载均衡的功能，管理一组WEB服务器，将请求根据负载均衡算法转发到不同WEB服务器上。一般反向代理服务器需要配置双网卡（内部IP和外部IP）。由于反向代理服务器转发请求中HTTP协议层面，因此也叫应用层负载均衡。其实，基于HTTP重定向和基于DNS的负载均衡，实际上也属于应用层负载均衡。

## 6. 集中式LB：基于IP的负载均衡 ##

最常见的基于IP的负载均衡策略：请求数据包到达负载均衡服务器后，负载均衡服务器OS内核进程获取网络数据包，根据负载均衡算法得到一台真实服务器地址，将请求目的地址修改为该真实IP地址，此过程不需要用户进程处理。真实服务器处理完成后，响应数据包回到负载均衡服务器，负载均衡服务器再将数据包源地址修改为自身IP地址，发送给调用方。这种方式下集群最大吞吐量受限于负载均衡服务器网卡带宽。

![基于IP的负载均衡](http://sweeat.me/LBip.jpg)

基于IP的负载均衡，如果加上端口转发的话就是4层负载均衡了，一个常见的例子是IPVS的NAT模式。

大多数Internet服务都有这样的特点，请求报文较短而响应报文往往包含大量的数据。如果能将请求和响应分开处理，即在负载调度器中只负责调度请求而响应直接返回给客户，将极大地提高整个集群系统的吞吐量。而IPVS的TUN模式采用IP隧道技术实现了这样的机制。

## 7. 集中式LB：基于链路层的负载均衡（DR） ##

在通信协议的数据链路层修改MAC地址进行负载均衡。数据分发时不修改IP地址，只修改目标MAC地址。真实服务器集群所有机器虚拟IP和负载均衡服务器IP地址一致，达到不修改数据包源地址和目标地址，进行数据分发的目的。基于链路层的负载均衡服务器只分发请求，响应数据从真实服务器直接返回调用方，所以又被称为三角传输模式。该种方式要求负载调度器与真实服务器RS都有一块网卡连在同一物理段上。

![基于链路层的负载均衡](http://sweeat.me/LBsjllc.png)

基于链路层的负载均衡的一个例子是IPVS的DR模式。

## 8. TLS/SSL负载均衡 ##

Https基于TLS/SSL，每个连接都要占用一个证书和一个会话，无法在多台服务器间分担SSL/TLS数据流。通常使用两种方法来进行SSL/TLS负载均衡。

* SSL前端（SSL Termination）：为连接单独设置一个前端专门处理证书卸载，并将处理后的非加密连接传给后面的服务器。
* SSL加速（SSL Acceleration）：需要给每台服务器添加一个特殊的硬件设备（加密解密卡），然后将所有的SSL处理都交给该设备。

## 参考 ##

LVS和IPVS。