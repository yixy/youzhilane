# 架构之路(10)——Web应用架构发展 #

## 1. 什么是Web应用 ##

Web是相互链接的文档的集合。

客户端client（例如Web浏览器）把请求发送给Web服务器，Web服务器再把请求发送给SGI（Web服务器网关接口，Web Server Gateway Interface，WSGI）。SGI程序实例解析完请求之后，需要根据URL到视图函数的映射关系，判断具体运行哪个视图函数（view function，其实质是一段程序代码，其返回的响应可以是包含html的简单字符串，也可以是复杂的表单），最终，视图函数的返回被处理后再发送回客户端。处理URL和函数之间关系的程序称为路由（route）。

## 2. 大型Web应用特点 ##

大型网站的技术挑战主要来自于庞大的用户，高并发的访问和海量的数据。

* 海量数据：需要存储、管理海量数据，需要使用大量服务器。
* 高并发、大流量：需要面对高并发用户，大流量访问。
* 高可用：系统7x24小时不间断服务。
* 用户分布广泛，网络情况复杂
* 安全环境恶劣
* 渐进式发展：与传统软件产品或企业应用系统一开始就规划好全部功能和非功能需求不同，几乎所有的大型互联网站都是从一个小网站开始，渐进地发展起来的。
* 需求快速变更，发布频繁

## 3. 初级网站架构 ##

最开始，应用程序、数据库、文件等所有资源都部署在一台服务器上。最常见的就是在一台服务器上部署LAMP（Linux、Apache、Mysql、PHP）。

![web1初级架构](http://sweeat.me/web1初级架构.png)

随着业务发展，单台服务器不能满足需求，可以考虑将应用拆分为多台服务器。通过将应用拆分为应用服务器、文件服务器和数据库服务器来实现应用服务和应用数据分离，利用不同配置的服务器完成不同的工作。这三台服务器对硬件资源的要求各不相同，应用服务器需要更快更强大的CPU，数据库服务器需要更快的磁盘和更大的内存（用于缓存数据），文件服务器需要更大的磁盘。

![web2应用服务和数据服务分离](http://sweeat.me/web2应用服务和数据服务分离.png)

## 4. 使用（分布式）缓存减少访问压力 ##

当业务继续发展，用户持续增加，应用瓶颈出现，数据库由于压力太大会导致访问延迟。因为网站大多数访问遵循二八规律（80%的业务访问集中在20%的数据上），所以当符合这种场景时，使用（分布式）缓存能够有效缓解数据库访问压力，提高整个网站的数据访问速度。

![web3使用缓存](http://sweeat.me/web3使用缓存.png)

注意，使用缓存的两个前提：

* 数据访问热点不均衡
* 数据在某个时间段内有效，不会很快过期

## 5. 使用应用服务器集群提高并发处理能力 ##

使用缓存后，数据访问压力得到有效缓解，但是单一应用服务器能够处理的请求连接有限，如果用户持续增加，应用服务器将成为瓶颈。通过使用负载均衡调度服务器，以及应用服务器集群，可将访问请求分发到应用服务器集群中的任何一台服务器上，以此消除应用服务器造成的负载压力瓶颈。

![web4应用服务器集群](http://sweeat.me/web4应用服务器集群.png)

## 6. 数据库读写分离 ##

使用了应用服务器集群之后，应用服务器不再成为系统的瓶颈。但是当数据库写操作到达一定规模时，数据库将成为系统瓶颈。目前大部分主流数据库都提供主从热备功能，可以利用这一点实现数据库读写分离。通常在应用服务器端使用专门的数据访问模块，使数据库读写分离对应用透明。

![web5数据库读写分离](http://sweeat.me/web5数据库读写分离.png)

## 7. 使用反向代理和CDN加速网站响应 ##

可以使用CDN和反向代理提升用户访问速度。

CDN和反向代理的基本原理都是缓存，区别在于CDN部署在网络提供商的机房，使用户在请求网站服务时，可以从距离自己最近的网络提供商机房获取数据；而反向代理则部署在网站的中心机房，当用户请求到达中心机房后，首先访问的服务器是反向代理服务器，如果反向代理服务器中缓存着用户请求的资源，就直接将其返回给用户。

![web6反向代理和CDN](http://sweeat.me/web6反向代理和CDN.png)

## 8. 使用分布式文件系统和分布式数据库系统 ##

分布式数据库是应用数据库拆分的最后手段，不到万不得已时一般不会使用（一个比较常见的场景是单表数据规模已经非常庞大）。文件系统也一样，可以使用分布式文件系统。

![web7分布式文件系统和分布式数据库](http://sweeat.me/web7分布式文件系统和分布式数据库.png)

## 9. 使用NoSQL和搜索引擎 ##

可以使用NoSQL和搜索引擎，通过统一数据模块访问数据。

![web8nosql和搜索引擎](http://sweeat.me/web8nosql和搜索引擎.png)

## 10. 垂直拆分（业务拆分） ##

任何单一服务器都满足不了一直持续增长的业务需求。当业务量到达一定程度时，就需要对数据库进行拆分。常见的数据库拆分手段是进行业务拆分，也被称为垂直拆分。业务拆分将一个应用拆分成为多个不同应用，进行业务分库，可以将不同业务数据部署在不同物理服务器上，每个应用独立维护。应用之间可以通过消息队列进行数据分发。

![web9垂直业务拆分](http://sweeat.me/web9垂直业务拆分.png)

## 11. 分布式服务 ##

当应用不断增大，巨型应用将带来以下问题：

* 编译、部署困难
* 数据库连接耗尽：所有应用服务器都需要和数据库建立连接。
* 扩展新功能困难

解决方案就是拆分，将模块独立部署，降低系统耦合性。除了前面提到的垂直拆分外，我们还可以采用水平拆分的方法，将可复用的业务拆分出来，独立部署为分布式服务，新增业务只需要调用这些分布式服务，不需要依赖具体的模块代码，即可快速搭建一个应用系统，而模块内业务逻辑变化的时候，只要接口保持一致就不会影响业务和其它模块。

注意，架构初期，就应尽量考虑分层的架构设计（逻辑上），这样后期进行水平拆分是很有益处的。

![web10分布式服务](http://sweeat.me/web10分布式服务.png)

## 12. 架构设计误区 ##

* 一味追求大公司的解决方案
* 为了技术而技术
* 企图用技术解决所有问题（技术是用来解决业务问题的，而业务的问题，也可以通过业务手段去解决）

## 参考 ##

《大型网站技术架构：核心原理与案例分析》，李智慧
