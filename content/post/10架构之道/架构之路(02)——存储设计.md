# 架构之路(02)——存储设计 #

## 1. 机械硬盘和固态硬盘 ##

* 机械硬盘：快速顺序读写、慢速随机读写、价格低廉。
* 固态硬盘：快速随机读写、价格昂贵、可靠性目前不如机械硬盘。

## 2. B+树和LSM树 ##

由于机械硬盘的特性，文件系统或数据库通常都会对数据排序后存储，以加快数据检索速度，这就需要保证数据在不断更新、插入、删除后依然有序。

传统关系型数据库的通常做法是使用B+树，多采用两级索引的B+树，树的层次最多三层。因此可能需要5次磁盘访问才能更新一条记录（三次访问获取数据索引及行ID，一次读操作，一次写操作）。

![B+树](http://sweeat.me/B+.jpg)

LSM树原理把一棵大树拆分成N棵小树，它首先写入内存中，随着小树越来越大，内存中的小树会flush到磁盘中，磁盘中的树定期可以做merge操作，合并成一棵大树，以优化读性能。LSM树和B+树相比，LSM树牺牲了部分读性能，用来大幅提高写性能。对数据的修改增量保持在内存中，达到指定的大小限制后将这些修改操作批量写入磁盘，不过读取的时候稍微麻烦，需要合并磁盘中历史数据和内存中最近修改操作，所以写入性能大大提升，读取时可能需要先看是否命中内存，否则需要访问较多的磁盘文件。

## 3. 数据备份 ##

数据冷备作为一种数据保护手段，仍然被各个大型企业所采用，但是冷备本身没办法提供系统高可用性。

数据热备通常分为同步热被和异步热备。

* 数据异步热备：采用Master-Slave架构，应用程序正常连接主节点进行写操作，主节点写操作代理模块将数据写入本机存储后立即返回成功，然后通过异步线程将写数据同步到从节点（有可能失败）。
* 数据同步热备：多份数据副本同时进行写入，只有所有写操作成功，应用服务器到数据服务系统才会认为写成功，应用服务器收到数据服务系统的失败响应时，可能全部或者部分写成功。