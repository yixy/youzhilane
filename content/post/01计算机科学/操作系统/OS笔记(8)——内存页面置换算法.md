# OS笔记(8)——内存页面置换算法 #

发生缺页中断时，OS必须在内存中选择一个页面将其换出内存，以便为即将调入的页面腾出空间。如果要换出的页面在内存驻留期间已经被修改过，就必须把它写回磁盘以更新该页面在磁盘上的副本；如果该页面没有被修改过，那么它的磁盘上的副本不需要被回写，直接使用调入的页面覆盖原有页面就行了。

最好的两种算法是老化算法和工作集时钟算法，它们分别基于LRU和工作集，具有良好的页面调度性能，可以有效的实现。

## 1. 最优页面算法 ##

该算法是可以给出的最好的页面算法，遗憾的是该算法不可能实现。

* 最优页面算法：假设每个页面都可以用在该页面首次被访问前要执行的指令数作为标记，该算法规定应置换标记最大的页面。

## 2. 最近未使用页面置换算法（Not Recently Used） ##

当启动一个进程时，操作系统为其每个页面设置两个状态位R和W（其初始值为0）：页面被访问时设置R位为1，页面被修改时设置W位为1。

注意，R位定期（比如时钟中断）会被清0，以区别最近没有被访问的页面和被访问的页面。

页面根据其R和W值可被分为四类：

```
第0类：R=0，M=0
第1类：R=0，M=1
第2类：R=1，M=0
第4类：R=1，M=1
```

* NRU算法：随机地从类编号最小的非空类中挑选一个页面淘汰之。

NRU算法可以看做是LRU算法的一个粗糙的实现。

## 3. 先进先出算法（First In First Out） ##

操作系统维护一个队列（通常是链表），存放内存中的页面，每次淘汰队首的页面，将最新进入的页面放到队尾。

因为可能抛弃重要页面，所以该算法一般不会单独使用。

## 4. 第二次机会页面置换算法（second chance） ##

第二次机会页面置换算法是FIFO算法的升级版。

* 第二次机会算法：对FIFO进行了简单的修改，在淘汰页面时，会判断该页R位是否被设置，若R位没被设置则淘汰该页面，否则将该页面R位清0，并且将其放入队尾，然后重新在队首进行搜索。

## 5. 时钟页面置换算法（clock） ##

clock算法是对FIFO和第二次机会算法的一个优化，使用环形链表实现数据结构，避免在链表中移动页面，减少不必要的开销。

## 6. 最近最少使用页面置换算法（Least Recently Used） ##

对最优页面置换算法的一个很好的近似是基于这样的观察：在前面几条指令中频繁使用的页面很可能在后面的几条指令中被使用。反过来说，已经很久没有使用的页面很可能在未来较长的一段时间内仍然不会被使用。

* LRU算法：在缺页中断发生时，置换掉未使用时间最长的页面。

虽然LRU在理论上是可以实现的，但代价很高。为了完全实现LRU，需要在内存中维护一个所有页面的链表，最近最多使用的页面在表头，最近最少使用的页面在表尾。困难的是在每次访问内存时都必须要更新整个链表。在链表中找到一个页面，删除它，然后把它移动到表头是一个非常费时的操作，即使使用硬件实现也一样费时（假设有这样的硬件）。

> 然而，还是有一些使用特殊硬件实现LRU的方法。首先考虑一个最简单的近似方法，这个方法要求硬件有一个64位计数器C，它在每条指令执行完后自动加1，每个页表项必须有一个足够容纳这个计数器值的域。在每次访问内存后，将当前的C值保存到被访问页面的页表项中。一旦发生缺页中断，操作系统就检查所有页表项中计数器的值，找到值最小的一个页面，这个页面就是最近最少使用的页面。（这看起来实际上是一个硬件版本的NUR算法）

> 现在让我们看一看第二个硬件实现的LRU算法。在一个有n个页框的机器中，LRU硬件可以维持一个初值为0的n×n位的矩阵。当访问到页框k时，硬件首先把k行的位都设置成1，再把k列的位都设置成0。在任何时刻，二进制数值最小的行就是最近最少使用的，第二小的行是下一个最近最少使用的，以此类推。

前面两种LRU算法虽然在理论上都是可以实现的，但只有非常少的计算机拥有这种硬件。因此，需要一个能用软件实现的解决方案。

## 7. 使用软件模拟LRU：NUR 和 老化算法 ##

只有非常少的计算机支持硬件实现LRU。因此，需要考虑一个能够使用软件实现的解决方案。

* NFU（Not Frequently Used，最不常用）算法：该算法将每个页面与一个软件计数器相关联，计数器的初值为0。每次时钟中断时，由操作系统扫描内存中所有的页面，将每个页面的R位（它的值是0或1）加到它的计数器上。这个计数器大体上跟踪了各个页面被访问的频繁程度。发生缺页中断时，则置换计数器值最小的页面。NFU的主要问题是它“从来不忘记任何事情”。
* 老化算法：老化算法对NFU进行了修正。首先，在R位被加进之前先将计数器右移一位；其次，将R位加到计数器最左端的位而不是最右端的位。发生缺页中断时，将置换计数器值最小的页面。

## 8. 工作集页面置换算法 ##

在进程运行的任何阶段，它都只访问较少的一部分页面。

* 进程工作集：一个进程当前正在使用的页面的集合称为它的工作集（working set）。

如果整个工作集都被装入到了内存中，那么进程在运行到下一运行阶段（例如，编译器的下一遍扫描）之前，不会产生很多缺页中断。请注意工作集是随着时间变化的。

工作集实际上就是最近k次内存访问所使用过的页面的集合。作为替代，可以使用几种近似的方法。一种常见的近似方法就是，不是向后找最近k次的内存访问，而是考虑其执行时间。

* 基于工作集的页面置换算法：基本思路就是找出一个不在工作集中的页面（在x时间内被访问过的页面）并淘汰它。
* 工作集时钟页面置换算法：工作集页面算法的时钟版本，具有更好的性能，并且可以高效的实现。
